:_mod-docs-content-type: ASSEMBLY
include::_attributes/common-attributes.adoc[]
[id="customizing-permissions-by-creating-user-defined-cluster-roles-for-cluster-scoped-instances"]
= Customizing permissions by creating user-defined cluster roles for cluster-scoped instances
:context: customizing-permissions-by-creating-user-defined-cluster-roles-for-cluster-scoped-instances

toc::[]

For the default cluster-scoped instance, the {gitops-title} Operator grants additional permissions for managing certain cluster-scoped resources. Consequently, as a cluster administrator, when you deploy an Argo CD as a cluster-scoped instance, the Operator creates additional cluster roles and cluster role bindings for the {gitops-shortname} control plane components. These cluster roles and cluster role bindings provide the additional permissions that Argo CD requires to operate at the cluster level. 

If you do not want the cluster-scoped instance to have all of the Operator-given permissions and choose to add or remove permissions to cluster-wide resources, you must first disable the creation of the default cluster roles for the cluster-scoped instance. Then, you can customize permissions for the following cluster-scoped instances:

* Default ArgoCD instance (default cluster-scoped instance)
* User-defined cluster-scoped Argo CD instance

This guide provides instructions with examples to help you create a user-defined cluster-scoped Argo CD instance, deploy an Argo CD application in your defined namespace that contains custom configurations for your cluster, disable the creation of the default cluster roles for the cluster-scoped instance, and customize permissions for user-defined cluster-scoped instances by creating new cluster roles and cluster role bindings for the {gitops-shortname} control plane components. 

[NOTE]
====
As a developer, if you are creating an Argo CD application and deploying cluster-wide resources, ensure that your cluster administrator grants the necessary permissions to them.

Otherwise, after the Argo CD reconciliation, you will see an authentication error message in the application's `Status` field similar to the following example:

.Example authentication error message

[source,terminal]
----
persistentvolumes is forbidden: User "system:serviceaccount:gitops-demo:argocd-argocd-application-controller" cannot create resource "persistentvolumes" in API group "" at the cluster scope.
----
====

[id="prerequisites_{context}"]
== Prerequisites

* You have installed {gitops-title} 1.13.0  or a later version on your {OCP} cluster.
* You have installed the OpenShift CLI (`oc`).
* You have installed the {gitops-title} `argocd` CLI.
* You have installed a xref:../declarative_clusterconfig/configuring-an-openshift-cluster-by-deploying-an-application-with-cluster-configurations.adoc#using-argo-cd-instance-to-manage-cluster-scoped-resources_configuring-an-openshift-cluster-by-deploying-an-application-with-cluster-configurations[cluster-scoped Argo CD instance] in your defined namespace. For example, `spring-petclinic` namespace. 
* You have validated that the user-defined cluster-scoped instance is configured with the cluster roles and cluster role bindings for the following components:
+
** Argo CD Application Controller
** Argo CD server
** Argo CD ApplicationSet Controller (provided the ApplicationSet Controller is created)
+
* You have deployed a `cluster-configs` xref:../declarative_clusterconfig/configuring-an-openshift-cluster-by-deploying-an-application-with-cluster-configurations.adoc#creating-an-application-by-using-the-argo-cd-dashboard_configuring-an-openshift-cluster-by-deploying-an-application-with-cluster-configurations[Argo CD application] with the `customclusterrole` link:https://github.com/redhat-developer/openshift-gitops-getting-started/tree/main/customclusterrole[path] in the `spring-petclinic` namespace and created the `test-gitops-ns` namespace and `test-gitops-pv` persistent volume resources.
+
[NOTE]
====
The `cluster-configs` Argo CD application must be managed by a user-defined cluster-scoped instance with the following parameters set:

* The `selfHeal` field value set to `true`
* The `syncPolicy` field value set to `automated`
* The  *Label* field set to the `app.kubernetes.io/part-of=argocd` value
* The  *Label* field set to the `argocd.argoproj.io/managed-by=<user_defined_namespace>` value so that the Argo CD instance in your defined namespace can manage your namespace
* The  *Label* field set to the `app.kubernetes.io/name=<user_defined_argocd_instance>` value
====

// Disabling the creation of the default cluster-scoped instance
include::modules/gitops-disabling-the-creation-of-the-default-cluster-roles-for-the-cluster-scoped-instance.adoc[leveloffset=+1]
[role="_additional-resources"]
.Additional resources
* xref:../argocd_instance/setting-up-argocd-instance.adoc#setting-up-argocd-instance[Installing a user-defined Argo CD instance]

// Customizing permissions for cluster-scoped instances
include::modules/gitops-customizing-permissions-for-cluster-scoped-instances.adoc[leveloffset=+1]

[role="_additional-resources"]
[id="additional-resources_{context}"]
== Additional resources

* xref:../declarative_clusterconfig/configuring-an-openshift-cluster-by-deploying-an-application-with-cluster-configurations.adoc#gitops-additional-permissions-for-cluster-config_configuring-an-openshift-cluster-by-deploying-an-application-with-cluster-configurations[Adding permissions for cluster configuration]
* xref:../argocd_instance/setting-up-argocd-instance.adoc#gitops-configuring-common-cluster-roles-by-specifying-user-defined-cluster-roles-for-namespace-scoped-instances_setting-up-argocd-instance[Configuring common cluster roles by specifying user-defined cluster roles for namespace-scoped instances]