:_content-type: ASSEMBLY
[id="mirroring-ocp-image-repository"]
= Mirroring the {product-title} image repository
include::_attributes/common-attributes.adoc[]
:context: mirroring-ocp-image-repository

toc::[]

You must mirror container images onto a mirror registry before you can update a cluster in a disconnected environment. You can also use this procedure in connected environments to ensure your clusters run only approved container images that have satisfied your organizational controls for external content.

[NOTE]
====
Your mirror registry must be running at all times while the cluster is running.
====

There are two methods for mirroring images onto a mirror registry:

* xref:../../updating/updating-restricted-network-cluster/mirroring-image-repository.adoc#mirroring-ocp-resources-ocmirror[Using the oc-mirror OpenShift CLI (`oc`) plugin]

* xref:../../updating/updating-restricted-network-cluster/mirroring-image-repository.adoc#update-mirror-repository-adm-release-mirror_mirroring-ocp-image-repository[Using the `oc adm release mirror` command]

Compared to using the `oc adm release mirror`command, the oc-mirror plugin has the following advantages:

* It can mirror content other than container images.

* After mirroring images for the first time, it is easier to update images in the registry.

* The oc-mirror plugin provides an automated way to mirror the release payload from Quay, and also builds the latest graph-data image for the OpenShift Update Service running in the disconnected environment.

[id="prerequisites_updating-mirroring-disconnected"]
== Prerequisites

* You must have a container image registry that supports link:https://docs.docker.com/registry/spec/manifest-v2-2[Docker v2-2] in the location that will host the {product-title} cluster, such as Red Hat Quay.
+
[NOTE]
====
If you use Red Hat Quay, you must use version 3.6 or later with the oc-mirror plugin. If you have an entitlement to Red Hat Quay, see the documentation on deploying Red Hat Quay link:https://access.redhat.com/documentation/en-us/red_hat_quay/3.6/html/deploy_red_hat_quay_for_proof-of-concept_non-production_purposes/[for proof-of-concept purposes] or link:https://access.redhat.com/documentation/en-us/red_hat_quay/3.6/html/deploy_red_hat_quay_on_openshift_with_the_quay_operator/[by using the Quay Operator]. If you need additional assistance selecting and installing a registry, contact your sales representative or Red Hat Support.
====
+
If you do not have an existing solution for a container image registry, the xref:../../installing/disconnected_install/installing-mirroring-creating-registry.adoc#installing-mirroring-creating-registry[mirror registry for Red Hat OpenShift] is included in {product-title} subscriptions. The _mirror registry for Red Hat OpenShift_ is a small-scale container registry that you can use to mirror {product-title} container images in disconnected installations and updates.

[id="updating-restricted-network-mirror-host"]
== Preparing your mirror host

Before you perform the mirror procedure, you must prepare the host to retrieve content and push it to the remote location.

include::modules/cli-installing-cli.adoc[leveloffset=+2]

[role="_additional-resources"]
.Additional resources

* xref:../../cli_reference/openshift_cli/extending-cli-plugins.adoc#cli-installing-plugins_cli-extend-plugins[Installing and using CLI plugins]

// this file doesn't exist, so I'm including the one that should pick up more changes from Clayton's PR - modules/installation-adding-mirror-registry-pull-secret.adoc[leveloffset=+1]

include::modules/installation-adding-registry-pull-secret.adoc[leveloffset=+2]

[id=mirroring-ocp-resources-ocmirror]
== Mirroring resources using the oc-mirror plugin

You can use the oc-mirror OpenShift CLI (`oc`) plugin to mirror images to a mirror registry in your fully or partially disconnected environments. You must run oc-mirror from a system with internet connectivity to download the required images from the official Red Hat registries.

The following steps outline the high-level workflow on how to use the oc-mirror plugin to mirror images to a mirror registry:

. Create an image set configuration file.
. Mirror the image set to the mirror registry by using one of the following methods:
** Mirror an image set directly to the mirror registry.
** Mirror an image set to disk, transfer the image set to the target environment, and then upload the image set to the target mirror registry.
. Install the `ImageContentSourcePolicy` and `CatalogSource` resources that were generated by oc-mirror into the cluster.
. Repeat these steps to update your mirror registry as necessary.

// About the oc-mirror plugin
include::modules/oc-mirror-about.adoc[leveloffset=+2]

// oc-mirror compatibility and support
include::modules/oc-mirror-support.adoc[leveloffset=+2]

// About the mirror registry
include::modules/installation-about-mirror-registry.adoc[leveloffset=+2]

[role="_additional-resources"]
.Additional resources

* For information about viewing the CRI-O logs to view the image source, see xref:../../installing/validating-an-installation.adoc#viewing-the-image-pull-source_validating-an-installation[Viewing the image pull source].

// Installing the oc-mirror OpenShift CLI plugin
include::modules/oc-mirror-installing-plugin.adoc[leveloffset=+2]

// Creating the image set configuration
include::modules/oc-mirror-creating-image-set-config.adoc[leveloffset=+2]

[role="_additional-resources"]
.Additional resources

* xref:../../updating/updating-restricted-network-cluster/mirroring-image-repository.adoc#oc-mirror-imageset-config-params_mirroring-ocp-image-repository[Image set configuration parameters]
* xref:../../updating/updating-restricted-network-cluster/mirroring-image-repository.adoc#oc-mirror-image-set-examples_mirroring-ocp-image-repository[Image set configuration examples]
* xref:../../updating/updating-restricted-network-cluster/restricted-network-update-osus.adoc#update-service-overview_updating-restricted-network-cluster-osus[About the OpenShift Update Service]

[id="mirroring-image-set"]
=== Mirroring an image set to a mirror registry

You can use the oc-mirror CLI plugin to mirror images to a mirror registry in a xref:../../updating/updating-restricted-network-cluster/mirroring-image-repository.adoc#mirroring-image-set-partial[partially disconnected environment] or in a xref:../../updating/updating-restricted-network-cluster/mirroring-image-repository.adoc#mirroring-image-set-full[fully disconnected environment].

The following procedures assume that you already have your mirror registry set up.

[id="mirroring-image-set-partial"]
==== Mirroring an image set in a partially disconnected environment

In a partially disconnected environment, you can mirror an image set directly to the target mirror registry.

// Mirroring from mirror to mirror
include::modules/oc-mirror-mirror-to-mirror.adoc[leveloffset=+4]

[id="mirroring-image-set-full"]
==== Mirroring an image set in a fully disconnected environment

To mirror an image set in a fully disconnected environment, you must first xref:../../updating/updating-restricted-network-cluster/mirroring-image-repository.adoc#oc-mirror-mirror-to-disk_mirroring-ocp-image-repository[mirror the image set to disk], then xref:../../updating/updating-restricted-network-cluster/mirroring-image-repository.adoc#oc-mirror-disk-to-mirror_mirroring-ocp-image-repository[mirror the image set file on disk to a mirror].

// Mirroring from mirror to disk
include::modules/oc-mirror-mirror-to-disk.adoc[leveloffset=+4]

// Mirroring from disk to mirror in a disconnected environment
include::modules/oc-mirror-disk-to-mirror.adoc[leveloffset=+4]

// Installing the ImageContentSourcePolicy and CatalogSource resources into the cluster
include::modules/oc-mirror-updating-cluster-manifests.adoc[leveloffset=+2]

[id="updating-mirror-registry-content"]
=== Keeping your mirror registry content updated

After you populate your target mirror registry with the initial image set, you must update it regularly so that it has the latest content. If possible, you can set up a cron job to update the mirror registry on a regular basis.

Update your image set configuration to add or remove {product-title} and Operator releases as necessary. Removed images are pruned from the mirror registry.

// About updating your mirror registry content
include::modules/oc-mirror-updating-registry-about.adoc[leveloffset=+3]

// Updating your mirror registry content
include::modules/oc-mirror-differential-updates.adoc[leveloffset=+3]

[role="_additional-resources"]
.Additional resources

* xref:../../updating/updating-restricted-network-cluster/mirroring-image-repository.adoc#oc-mirror-image-set-examples_mirroring-ocp-image-repository[Image set configuration examples]
* xref:../../updating/updating-restricted-network-cluster/mirroring-image-repository.adoc#mirroring-image-set-partial[Mirroring an image set in a partially disconnected environment]
* xref:../../updating/updating-restricted-network-cluster/mirroring-image-repository.adoc#mirroring-image-set-full[Mirroring an image set in a fully disconnected environment]
* xref:../../updating/updating-restricted-network-cluster/mirroring-image-repository.adoc#oc-mirror-updating-cluster-manifests_mirroring-ocp-image-repository[Installing the ImageContentSourcePolicy and CatalogSource resources into the cluster]

// Performing a dry run
include::modules/oc-mirror-dry-run.adoc[leveloffset=+2]

[role="_additional-resources"]
.Additional resources

* xref:../../operators/admin/olm-managing-custom-catalogs.adoc#olm-managing-custom-catalogs-fb[File-based catalogs]

// Image set configuration parameters
include::modules/oc-mirror-imageset-config-params.adoc[leveloffset=+2]

// Image set configuration examples
include::modules/oc-mirror-image-set-config-examples.adoc[leveloffset=+2]

// Command reference for oc-mirror
include::modules/oc-mirror-command-reference.adoc[leveloffset=+2]

include::modules/update-mirror-repository.adoc[leveloffset=+1]