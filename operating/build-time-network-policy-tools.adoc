:_content-type: ASSEMBLY
[id="build-time-network-policy-tools"]
= Build-time network policy tools
include::modules/common-attributes.adoc[]
:context: network-policy-tools

toc::[]

[role="_abstract"]
Build-time network policy tools let you automate the creation and validation of Kubernetes network policies in your development and operations workflows using the `roxctl` CLI. These tools work with a specified file directory containing your project's workload and network policy manifests and do not require {product-title-short} authentication.

.Network policy tools
[%autowidth,options="header"]
|===
|Command |Description

|`roxctl netpol generate`
|Generates Kubernetes network policies by analyzing your project's YAML manifests in a specified directory. For more information, see xref:../operating/build-time-network-policy-tools.adoc#using-the-build-time-network-policy-generator_network-policy-tools[Using the build-time network policy generator].

|`roxctl netpol connectivity map`
|Lists the allowed connections between workloads in your project directory by examining the workload and Kubernetes network policy manifests. You can generate the output in various text formats or in a graphical `.dot` format. For more information, see xref:../operating/build-time-network-policy-tools.adoc#connectivity-mapping-using-the-roxctl-netpol-connectivity-map-command_network-policy-tools[Connectivity mapping using the roxctl netpol connectivity map command].

|`roxctl netpol connectivity diff`
|Creates a list of variations in the allowed connections between two project versions. This is determined by the workload and Kubernetes network policy manifests in each version's directory. This feature shows the semantic differences which are not obvious when performing a source code (syntactic) `diff`. For more information, see xref:../operating/build-time-network-policy-tools.adoc#identifying-the-differences-in-allowed-connections-between-project-versions_network-policy-tools[Identifying the differences in allowed connections between project versions].

|===

//Network policy generator
[id="using-the-build-time-network-policy-generator_{context}"]
== Using the build-time network policy generator

:FeatureName: Build-time network policy generation
include::snippets/technology-preview.adoc[]

The build-time network policy generator can automatically generate Kubernetes network policies based on application YAML manifests. You can use it to develop network policies as part of the continuous integration/continuous deployment (CI/CD) pipeline before deploying applications on your cluster.

Red Hat developed this feature in partnership with the developers of the link:https://np-guard.github.io/[NP-Guard project].
First, the build-time network policy generator analyzes Kubernetes manifests in a local folder, including service manifests, config maps, and workload manifests such as `Pod`, `Deployment`, `ReplicaSet`, `Job`, `DaemonSet`, and `StatefulSet`.
Then, it discovers the required connectivity and creates the Kubernetes network policies to achieve pod isolation.
These policies allow no more and no less than the needed ingress and egress traffic.

[id="generate-build-time-network-policies_{context}"]
=== Generating build-time network policies

[role="_abstract"]
The build-time network policy generator is included in the `roxctl` CLI.
For the build-time network policy generation feature, `roxctl` CLI does not need to communicate with {product-title-short} Central so you can use it in any development environment.

.Prerequisites
. The build-time network policy generator recursively scans the directory you specify when you run the command.
Therefore, before you run the command, you must already have service manifests, config maps, and workload manifests such as `Pod`, `Deployment`, `ReplicaSet`, `Job`, `DaemonSet`, and `StatefulSet` as YAML files in the specified directory.
. Verify that you can apply these YAML files as-is using the `kubectl apply -f` command. The build-time network policy generator does not work with files that use Helm style templating.
. Verify that the service network addresses are not hard-coded. Every workload that needs to connect to a service must specify the service network address as a variable. You can specify this variable by using the workload's resource environment variable or in a config map.

** link:https://github.com/np-guard/cluster-topology-analyzer/blob/main/tests/k8s_guestbook/frontend-deployment.yaml#L25:L28[Example 1: using an environment variable]
** link:https://github.com/np-guard/cluster-topology-analyzer/blob/main/tests/onlineboutique/kubernetes-manifests.yaml#L105:L109[Example 2: using a config map]
** link:https://github.com/np-guard/cluster-topology-analyzer/blob/main/tests/onlineboutique/kubernetes-manifests.yaml#L269:L271[Example 3: using a config map]
. Service network addresses must match the following official regular expression pattern:
+
----
(http(s)?://)?<svc>(.<ns>(.svc.cluster.local)?)?(:<portNum>)? <1>
----
+
<1> In this pattern,
* <svc> is the service name.
* <ns> is the namespace where you defined the service.
* <portNum> is the exposed service port number.

+
Following are some examples that match the pattern:

* `wordpress-mysql:3306`
* `redis-follower.redis.svc.cluster.local:6379`
* `redis-leader.redis`
* `+http://rating-service.+`


.Procedure
. Verify that the build-time network policy generation feature is available by running the help command:
+
[source,terminal]
----
$ roxctl netpol generate -h
----
. Generate the policies by using the `netpol generate` command:
+
[source,terminal,subs="+quotes"]
----
$ roxctl netpol generate _<folder_path>_ [flags] <1>
----
+
<1> Specify the path to the folder, which can include sub-folders that contain YAML resources for analysis. The command scans the entire sub-folder tree. Optionally, you can also specify parameters to modify the behavior of the command.
+
For more information about optional parameters, see xref:../operating/build-time-network-policy-tools.adoc#roxctl-netpol-generate-command-options_network-policy-tools[roxctl netpol generate command options].

.Next steps

* After generating the policies, you must inspect them for completeness and accuracy, in case any relevant network address was not specified as expected in the YAML files.

* Most importantly, verify that required connections are not blocked by the isolating policies. To help with this inspection you can use the `roxctl netpol connectivity map` tool.

[NOTE]
====
Applying network policies to the cluster as part of the workload deployment using automation saves time and ensures accuracy.
You can follow a GitOps approach by submitting the generated policies using pull requests, providing the team an opportunity to review the policies before deploying them as part of the pipeline.
====

include::modules/roxctl-netpol-generate-command-options.adoc[leveloffset=+2]

//Connectivity mapping
include::modules/connectivity-mapping-using-the-roxctl-netpol-connectivity-map-command.adoc[leveloffset=+1]

[id="retrieving-connectivity-mapping-information-from-a-kubernetes-manifest-directory_{context}"]
=== Retrieving connectivity mapping information from a Kubernetes manifest directory

.Procedure

* Run the following command to retrieve the connectivity mapping information:
+
[source,terminal,subs="+quotes"]
----
$ roxctl netpol connectivity map _<folder_path>_ [flags] <1>
----
+
<1> Specify the path to the folder, which can include sub-folders that contain YAML resources and network policies for analysis, for example, link:https://github.com/np-guard/netpol-analyzer/tree/main/tests/netpol-analysis-example-minimal[`netpol-analysis-example-minimal/`]. The command scans the entire sub-folder tree. Optionally, you can also specify parameters to modify the behavior of the command.
+
For more information about optional parameters, see xref:../operating/build-time-network-policy-tools.adoc#roxctl-netpol-connectivity-map-command-options_network-policy-tools[roxctl netpol connectivity map command options].
+
.Example output
+
====
[%autowidth,options="header"]
|===

|src |dst |conn

|0.0.0.0-255.255.255.255
|default/frontend[Deployment]
|TCP 8080

|default/frontend[Deployment]
|0.0.0.0-255.255.255.255
|UDP 53

|default/frontend[Deployment]
|default/backend[Deployment]
|TCP 9090

|===
====

The output shows you a table with a list of allowed connectivity lines. Each connectivity line consists of three parts: source (`src`), destination (`dst`), and allowed connectivity attributes (`conn`).

You can interpret `src` as the source endpoint, `dst` as the destination endpoint, and `conn` as the allowable connectivity attributes. An endpoint has the format `namespace/name[Kind]`, for example, `default/backend[Deployment]`.

include::modules/connectivity-map-output-formats-and-visualizations.adoc[leveloffset=+2]

include::modules/generating-svg-graphs-from-the-dot-output-using-graphviz.adoc[leveloffset=+2]

include::modules/roxctl-netpol-connectivity-map-command-options.adoc[leveloffset=+2]

//Connectivity diff
include::modules/identifying-the-differences-in-allowed-connections-between-project-versions.adoc[leveloffset=+1]

[id="generating-connectivity-difference-reports-with-the-roxctl-netpol-connectivity-diff-command_{context}"]
=== Generating connectivity difference reports with the roxctl netpol connectivity diff command

To produce a connectivity difference report, the `roxctl netpol connectivity diff` command requires two folders, `dir1` and `dir2`, each containing Kubernetes manifests, including network policies.

.Procedure

* Run the following command to determine the connectivity differences between the Kubernetes manifests in the specified directories:
+
[source,terminal,subs="+quotes"]
----
$ roxctl netpol connectivity diff --dir1=_<folder_path_1>_ --dir2=_<folder_path_2>_ [flags] <1>
----
+
<1> Specify the path to the folders, which can include sub-folders that contain YAML resources and network policies for analysis. The command scans the entire sub-folder trees for both the directories.
For example, `<folder_path_1>` is link:https://github.com/np-guard/netpol-analyzer/tree/main/tests/netpol-analysis-example-minimal[`netpol-analysis-example-minimal/`] and `<folder_path_2>` is link:https://github.com/np-guard/netpol-analyzer/tree/main/tests/netpol-diff-example-minimal[`netpol-diff-example-minimal/`]. Optionally, you can also specify parameters to modify the behavior of the command.
+
For more information about optional parameters, see xref:../operating/build-time-network-policy-tools.adoc#roxctl-netpol-connectivity-diff-command-options_network-policy-tools[roxctl netpol connectivity diff command options].
+
[NOTE]
====
The command considers all YAML files that you can accept using `kubectl apply -f`, and then these become valid inputs for your `roxctl netpol connectivity diff` command.
====
+
.Example output
+
====
[%autowidth,options="header"]
|===

|diff-type |source |destination |dir 1 |dir 2 |workloads-diff-info

|changed
|default/frontend[Deployment]
|default/backend[Deployment]
|TCP 9090
|TCP 9090,UDP 53
|

|added
|0.0.0.0-255.255.255.255
|default/backend[Deployment]
|No Connections
|TCP 9090
|

|===
====

The semantic difference report gives you an overview of the connections that were changed, added, or removed in `dir2` compared to the connections allowed in `dir1`. When you review the output, each line represents one allowed connection that was added, removed, or changed in `dir2` compared to `dir1`.

The following are example outputs generated by the `roxctl netpol connectivity diff` command in various formats:

** link:https://github.com/np-guard/netpol-analyzer/blob/main/tests/netpol-diff-example-minimal/diff_output_from_netpol-analysis-example-minimal.txt[Example 1: text format]
+
** link:https://github.com/np-guard/netpol-analyzer/blob/main/tests/netpol-diff-example-minimal/diff_output_from_netpol-analysis-example-minimal.md[Example 2: md format]
+
** link:https://github.com/np-guard/netpol-analyzer/blob/main/tests/netpol-diff-example-minimal/diff_output_from_netpol-analysis-example-minimal.csv[Example 3: csv format]

If applicable, the `workloads-diff-info` provides additional details about added or removed workloads related to the added or removed connection.

For example, if a connection from workload `A` to workload `B` is removed because workload `B` was deleted, the `workloads-diff-info` indicates that workload `B` was removed. However, if such a connection was removed only because of network policy changes and neither workload `A` nor `B` was deleted, the `workloads-diff-info` is empty.

include::modules/roxctl-netpol-connectivity-diff-command-options.adoc[leveloffset=+2]

include::modules/distinguishing-between-syntactic-and-semantic-difference-outputs.adoc[leveloffset=+2]

include::modules/syntactic-difference-output.adoc[leveloffset=+3]

include::modules/semantic-difference-output.adoc[leveloffset=+3]