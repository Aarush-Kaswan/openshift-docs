// Module included in the following assemblies:
// * serverless-logic/serverless-logic-managing-supporting-services


:_mod-docs-content-type: REFERENCE
[id="serverless-logic-supporting-services-persistence-configuration_{context}"]
= Supporting services persistence configurations

The persistence configuration for supporting services in {ServerlessLogicProductName} can be either ephemeral or PostgreSQL, depending on needs of your environment. Ephemeral persistence is ideal for development and testing, while PostgreSQL persistence is recommended for production environments.

[id="serverless-logic-supporting-services-ephemeral-persistence-config_{context}"]
== Ephemeral persistence configuration

The ephemeral persistence uses an embedded PostgreSQL database that is dedicated to each service. The {ServerlessLogicOperatorName} recreates this database with every service restart, making it suitable only for development and testing purposes. You do not need any additional configuration other than the following `SonataFlowPlatform` CR:  

[source,yaml]
----
apiVersion: sonataflow.org/v1alpha08
kind: SonataFlowPlatform
metadata:
  name: sonataflow-platform-example
  namespace: example-namespace
spec:
  services:
    dataIndex: 
      enabled: true 
      # Specific configurations for the Data Index Service
      # might be included here
    jobService: 
      enabled: true 
      # Specific configurations for the Job Service
      # might be included here
----

[id="serverless-logic-supporting-services-postgresql-persistence-config_{context}"]
== PostgreSQL persistence configuration

For PostgreSQL persistence, you must set up a PostgreSQL server instance on your cluster. The administration of this instance remains independent of the {ServerlessLogicOperatorName} control. To connect a supporting service with the PostgreSQL server, you must configure the appropriate database connection parameters.

You can configure PostgreSQL persistence in the `SonataFlowPlatform` CR by using the following example:

.Example of PostgreSQL persistence configuration
[source,yaml]
----
apiVersion: sonataflow.org/v1alpha08
kind: SonataFlowPlatform
metadata:
  name: sonataflow-platform-example
  namespace: example-namespace
spec:
  services:
    dataIndex:
      enabled: true
      persistence:
        postgresql:
          serviceRef:
            name: postgres-example <1>
            namespace: postgres-example-namespace <2>
            databaseName: example-database <3>
            databaseSchema: data-index-schema <4>
            port: 1234 <5>
          secretRef:
            name: postgres-secrets-example <6>
            userKey: POSTGRESQL_USER <7>
            passwordKey: POSTGRESQL_PASSWORD <8>
    jobService:
      enabled: true
      persistence:
        postgresql:
        # Specific database configuration for the Job Service
        # might be included here.
----

<1> Name of the service to connect with the PostgreSQL database server.
<2> Optional: Defines the namespace of the PostgreSQL Service. Defaults to the SonataFlowPlatform namespace.
<3> Defines the name of the PostgreSQL database for storing supporting service data.
<4> Optional: Specifies the schema for storing supporting service data. Default value is `SonataFlowPlatform` name, suffixed with `-data-index-service` or `-jobs-service`. For example, `sonataflow-platform-example-data-index-service`.
<5> Optional: Port number to connect with the PostgreSQL Service. Default value is `5432`.
<6> Defines the name of the secret containing the username and password for database access.
<7> Defines the name of the key in the secret that contains the username to connect with the database.
<8> Defines the name of the key in the secret that contains the password to connect with the database.

[NOTE]
====
You can configure each serviceâ€™s persistence independently by using the respective persistence field.
====

Create the secrets to access PostgreSQL by running the following command:

[source,terminal]
----
$ oc create secret generic <postgresql_secret_name> \
  --from-literal=POSTGRESQL_USER=<user> \
  --from-literal=POSTGRESQL_PASSWORD=<password> \
  -n <namespace>
----

[id="serverless-logic-supporting-services-common-postgresql-persistence-config_{context}"]
== Common PostgreSQL persistence configuration

The {ServerlessLogicOperatorName} automatically connects supporting services to the common PostgreSQL server configured in the `spec.persistence` field. 

For rules, the following precedence is applicable:

* If you configure a specific persistence for a supporting service, for example, `services.dataIndex.persistence`, it uses that configuration.
* If you do not configure persistence for a service, the system uses the common persistence configuration from the current platform.

[NOTE]
====
When using a common PostgreSQL configuration, each service schema is automatically set as the `SonataFlowPlatform` name, suffixed with `-data-index-service` or `-jobs-service`, for example, `sonataflow-platform-example-data-index-service`.
====