// Module included in the following assemblies:
//
// * argocd_applications/creating-an-application-using-gitops-argocd-cli.adoc
// * declarative_clusterconfig/configuring-an-openshift-cluster-by-deploying-an-application-with-cluster-configurations.adoc

ifeval::["{context}" == "configuring-an-openshift-cluster-by-deploying-an-application-with-cluster-configurations"]
:cluster:
endif::[]
ifeval::["{context}" == "creating-an-application-using-gitops-argocd-cli"]
:app:
endif::[]

:_mod-docs-content-type: PROCEDURE
[id="gitops-argocd-cli-creating-an-application-in-default-mode_{context}"]
= Creating an application in the default mode by using the GitOps CLI

You can create applications in the default mode by using the {gitops-shortname} `argocd` CLI.

ifdef::cluster[]
This sample workflow walks you through the process of configuring Argo CD to recursively sync the content of the `cluster` directory to the `cluster-configs` application. The directory defines the {OCP} cluster configurations and the `spring-petclinic` namespace on the cluster.
endif::cluster[]

.Prerequisites

* You have installed the {gitops-title} Operator on your {OCP} cluster.
* You have installed the OpenShift CLI (`oc`).
* You have installed the {gitops-title} `argocd` CLI.
* You have logged in to Argo CD instance.

.Procedure

. Get the `admin` account password for the Argo CD server:
+
[source,terminal]
----
$ ADMIN_PASSWD=$(oc get secret openshift-gitops-cluster -n openshift-gitops -o jsonpath='{.data.admin\.password}' | base64 -d)
----

. Get the Argo CD server URL:
+
[source,terminal]
----
$ SERVER_URL=$(oc get routes openshift-gitops-server -n openshift-gitops -o jsonpath='{.status.ingress[0].host}')
----

. Log in to the Argo CD server by using the `admin` account password and enclosing it in single quotes:
+
[IMPORTANT]
====
Enclosing the password in single quotes ensures that special characters, such as `$`, are not misinterpreted by the shell. Always use single quotes to enclose the literal value of the password.
====
+
[source,terminal]
----
$ argocd login --username admin --password ${ADMIN_PASSWD} ${SERVER_URL}
----
+
.Example
[source,terminal]
----
$ argocd login --username admin --password '<password>' openshift-gitops.openshift-gitops.apps-crc.testing
----

. Verify that you are able to run `argocd` commands in the default mode by listing all applications:
+
[source,terminal]
----
$ argocd app list
----
+
If the configuration is correct, then existing applications will be listed with the following header:
+
.Sample output
[source,terminal]
----
NAME CLUSTER NAMESPACE  PROJECT  STATUS  HEALTH   SYNCPOLICY  CONDITIONS  REPO PATH TARGET
----

ifdef::cluster[]
. Create an application in the default mode:
+
[source,terminal]
----
$ argocd app create app-cluster-configs \
    --repo https://github.com/redhat-developer/openshift-gitops-getting-started.git \
    --path cluster \
    --revision main \
    --dest-server  https://kubernetes.default.svc \
    --dest-namespace spring-petclinic \
    --directory-recurse \
    --sync-policy none \
    --sync-option Prune=true \
    --sync-option CreateNamespace=true
----
endif::cluster[]

ifdef::app[]
. Create an application in the default mode:
+
[source,terminal]
----
$ argocd app create app-spring-petclinic \
    --repo https://github.com/redhat-developer/openshift-gitops-getting-started.git \
    --path app \
    --revision main \
    --dest-server  https://kubernetes.default.svc \
    --dest-namespace spring-petclinic \
    --directory-recurse \
    --sync-policy automated \
    --self-heal \
    --sync-option Prune=true \
    --sync-option CreateNamespace=true
----
endif::app[]

. Label the `spring-petclinic` destination namespace to be managed by the `openshif-gitops` Argo CD instance:
+
[source,terminal]
----
$ oc label ns spring-petclinic "argocd.argoproj.io/managed-by=openshift-gitops"
----

ifdef::cluster[]
. List the available applications to confirm that the application is created successfully: 
+
[source,terminal]
----
$ argocd app list
----
+
Even though the `cluster-configs` Argo CD application has the `Healthy` status, it is not automatically synced due to its `none` sync policy, causing it to remain in the `OutOfSync` status.
endif::cluster[]

ifdef::app[]
. List the available applications to confirm that the application is created successfully and repeat the command until the application has the `Healthy` and `Synced` statuses:
+
[source,terminal]
----
$ argocd app list
----
endif::app[]
