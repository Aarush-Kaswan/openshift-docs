// Module included in the following assemblies:
//
// * integration/integrate-using-short-lived-tokens.adoc
:_mod-docs-content-type: PROCEDURE
[id="amazon-secure-token-service-openshift_{context}"]
= Configuring {ocp}

[role="_abstract"]
When running {rh-rhacs-first} on {ocp}, you can configure short-lived tokens through the Amazon Secure Token Service.

.Prerequisites
* You must have a public OpenID Connect (OIDC) configuration bucket with the {ocp} service account signer key. To get the OIDC configuration for the {ocp} cluster, Red Hat recommends using the instructions at link:https://docs.openshift.com/container-platform/4.14/authentication/managing_cloud_provider_credentials/cco-short-term-creds.html[Cloud Credential Operator in manual mode for short-term credentials].
* You must have access to AWS IAM and the permissions to create and change roles.

.Procedure
. Follow the instructions at link:https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_providers_create_oidc.html[Creating OpenID Connect (OIDC) identity providers] to create web identity of the {ocp} cluster. Use `openshift` as the value for *Audience*.
. link:https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_create_for-idp_oidc.html[Create an IAM role] for the web identity of the {ocp} cluster.
. Edit the permission policy of the role and grant the permissions required by the integration. For example:
+
[source,json]
----
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "VisualEditor0",
            "Effect": "Allow",
            "Action": [
                "ecr:BatchCheckLayerAvailability",
                "ecr:BatchGetImage",
                "ecr:DescribeImages",
                "ecr:DescribeRepositories",
                "ecr:GetAuthorizationToken",
                "ecr:GetDownloadUrlForLayer",
                "ecr:ListImages"
            ],
            "Resource": "arn:aws:iam::<ecr_registry>:role/<role_name>"
        }
    ]
}
----
. Update the trust relationship for the role that you want to assume:
+
[source,json]
----
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Principal": {
                "Federated": "<oidc_provider_arn>"
            },
            "Action": "sts:AssumeRoleWithWebIdentity",
            "Condition": {
                "StringEquals": {
                    "<oidc_provider_name>:aud": "openshift"
                }
            }
        }
    ]
}
----
. Set the following {product-title-short} environment variables on the Central or Sensor deployment:
+
[source]
----
AWS_ROLE_ARN=<role_arn>
AWS_WEB_IDENTITY_TOKEN_FILE=/var/run/secrets/openshift/serviceaccount/token
----
