// This module is included in the following assembly:
//
// * work-with-builds/using-builds.adoc

:_content-type: PROCEDURE
[id="ob-creating-a-s2i-build_{context}"]
= Creating a source-to-image build

You can create a `source-to-image` build and push the created image to a custom Quay repository.

.Prerequisites

* You have installed the {builds-operator} on the {ocp-product-title} cluster.
* You have created a `ShipwrightBuild` resource.
* You have installed the `source-to-image` strategy. You can use the following command to verify if the `source-to-image` strategy is installed:
+ 
[source,terminal]
----
$ oc get cbs | grep source-to-image
----
+
[NOTE]
====
If the `source-to-image` strategy is not installed, see _Installing source-to-image strategy_ in the _Additional resources_ section.
====

.Procedure

. Create a `Build` resource and apply it to the {ocp-product-title} cluster:
+
[source,terminal]
----
$ oc apply -f - <<EOF     
apiVersion: shipwright.io/v1beta1
kind: Build
metadata:
  name: s2i-nodejs-build
spec:
  source: <1>
    git:
      url: https://github.com/shipwright-io/sample-nodejs
    contextDir: source-build/
  strategy: <2>
    name: source-to-image
    kind: ClusterBuildStrategy
  paramValues: <3>
  - name: builder-image
    value: quay.io/centos7/nodejs-12-centos7
  output: <4>
    image: quay.io/<repo>/s2i-nodejs-example
    pushSecret: registry-credential
EOF
----
<1> The location where the source code is placed.
<2> The build strategy that you use to build the container.
<3> A name-value list to specify values for parameters defined in the build strategy. To set the value of the `builder-image` strategy parameter, specify the builder image location required to build the output image.
<4> The location where the built image is pushed. You can push the built image to a custom Quay repo. `pushSecret` is the secret name that stores the credentials for pushing container images. To generate a secret of the type `docker-registry` for authentication, see _Authentication to container registries_ in the _Additional resources_ section.

. Run the following command to check if the `Build` resource is created:
+
[source,terminal]
----
$ oc get builds.shipwright.io s2i-nodejs-build
----

. Create a `BuildRun` resource and apply it to the {ocp-product-title} cluster:
+
[source,terminal]
----
$ oc apply -f - <<EOF
apiVersion: shipwright.io/v1beta1
kind: BuildRun
metadata:
  name: s2i-nodejs-buildrun
spec:
  build:
    name: s2i-nodejs-build <1>
EOF
----
<1> The `spec.build.name` field denotes the respective build to run, which is expected to be available in the same namespace.

. Run the following command to check if the `BuildRun` resource is created:
+
[source,terminal]
----
$ oc get buildrun s2i-nodejs-buildrun
----
+
The `BuildRun` resource creates a `TaskRun` resource, which then creates the pods to execute build strategy steps.

.Verification

. After all the containers complete their tasks, verify the following:
+
* Check whether the pod shows the `STATUS` field as `Completed`:
+
[source,terminal]
----
$ oc get pods -w
----
+
.Example output
[source,terminal]
----
NAME                                READY   STATUS     RESTARTS   AGE
s2i-nodejs-buildrun-phxxm-pod       2/2     Running    0          10s
s2i-nodejs-buildrun-phxxm-pod       1/2     NotReady   0          14s
s2i-nodejs-buildrun-phxxm-pod       0/2     Completed  0          2m
----
+
* Check whether the respective `TaskRun` resource shows the `SUCCEEDED` field as `True`:
+
[source,terminal]
----
$ oc get tr
----
+
.Example output
[source,terminal]
----
NAME                           SUCCEEDED  REASON     STARTTIME   COMPLETIONTIME
s2i-nodejs-buildrun-phxxm      True       Succeeded  2m39s        13s
----
+
* Check whether the respective `BuildRun` resource shows the `SUCCEEDED` field as `True`:
+
[source,terminal]
----
$ oc get br
----
+
.Example output
[source,terminal]
----
NAME                     SUCCEEDED   REASON       STARTTIME     COMPLETIONTIME
s2i-nodejs-buildrun      True        Succeeded    2m41s           15s
----
+
During verification, if a build run fails, you can check the `status.failureDetails` field in your `BuildRun` resource to identify the exact point where the failure happened in the pod or container. 
+
[NOTE]
====
The pod might switch to a `NotReady` state because one of the containers has completed its task. This is an expected behavior.
====

. Validate whether the image has been pushed to the registry that is specified in the `build.spec.output.image` field. You can try to pull the image by running the following command after logging in to the registry:
+
[source,terminal]
----
$ podman pull quay.io/<repo>/<image> <1>
----
<1> The repository name and image name used when creating the `Build` resource. For example, you can use `s2i-nodejs-example` as the image name.