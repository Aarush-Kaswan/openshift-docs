// Module included in the following assemblies:
//
// * integration/integrate-using-short-lived-tokens.adoc
:_mod-docs-content-type: PROCEDURE
[id="google-workload-identity-federation-openshift_{context}"]
= Configuring {ocp}

[role="_abstract"]
You can configure short-lived tokens through Google workload identities when running {rh-rhacs-first} on {ocp}.

.Prerequisites
* You must have a public OIDC configuration bucket with the {ocp} service account signer key. The recommended way to obtain the OIDC configuration for the {ocp} cluster is to use the link:https://docs.openshift.com/container-platform/4.14/authentication/managing_cloud_provider_credentials/cco-short-term-creds.html[Cloud Credential Operator in manual mode for short-term credentials] instructions.
* Access to a Google Cloud project with the *roles/iam.workloadIdentityPoolAdmin* role.

.Procedure
. Follow the instructions at link:https://cloud.google.com/iam/docs/manage-workload-identity-pools-providers#iam-workload-pools-list-gcloud[Manage workload identity pools] to create a workload identity pool. For example:
+
[source,terminal]
----
$ gcloud iam workload-identity-pools create rhacs-pool \
    --location="global" \
    --display-name="RHACS workload pool"
----

. Follow the instructions at link:https://cloud.google.com/iam/docs/manage-workload-identity-pools-providers#manage-providers[Manage workload identity pool providers] to create a workload identity pool provider. For example:
+
[source,terminal]
----
$ gcloud iam workload-identity-pools providers create-oidc rhacs-provider \
    --location="global" \
    --workload-identity-pool="rhacs-pool" \
    --display-name="RHACS provider" \
    --attribute-mapping="google.subject=assertion.sub" \
    --issuer-uri="https://<oidc_configuration_url>" \
    --allowed-audiences=openshift
----

. Connect a Google service account to the workload identity pool. For example:
+
[source,terminal]
----
$ gcloud iam service-accounts add-iam-policy-binding <GSA_NAME>@<GSA_PROJECT>.iam.gserviceaccount.com \
    --role roles/iam.workloadIdentityUser \
    --member="principal://iam.googleapis.com/projects/<GSA_PROJECT_NUMBER>/locations/global/workloadIdentityPools/rhacs-provider/subject/system:serviceaccount:stackrox:central" <1>
----
<1> For delegated scanning, set the subject to *system:serviceaccount:stackrox:sensor*.

. Create a service account JSON containing the Security token service (STS) configuration. For example:
+
[source,json]
----
{
  "type": "external_account",
  "audience": "//iam.googleapis.com/projects/<GSA_PROJECT_ID>/locations/global/workloadIdentityPools/rhacs-pool/providers/rhacs-provider",
  "subject_token_type": "urn:ietf:params:oauth:token-type:jwt",
  "token_url": "https://sts.googleapis.com/v1/token",
  "service_account_impersonation_url": "https://iamcredentials.googleapis.com/v1/projects/-/serviceAccounts/<GSA_NAME>@<GSA_PROJECT>.iam.gserviceaccount.com:generateAccessToken",
  "credential_source": {
    "file": "/var/run/secrets/openshift/serviceaccount/token",
    "format": {
      "type": "text"
    }
  }
}
----

. Use the service account JSON as a secret to the {product-title-short} namespace:
+
[source,yaml]
----
apiVersion: v1
kind: Secret
metadata:
  name: gcp-cloud-credentials
  namespace: stackrox
data:
  credentials: <base64_encoded_json>
----
