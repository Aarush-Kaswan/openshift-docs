// Module included in the following assemblies:
//
// * upgrade/upgrade-operator.adoc
// * cloud_service/upgrade-cloudsvc-operator.adoc
:_mod-docs-content-type: PROCEDURE
[id="rollback-operator-upgrades_{context}"]
= Rolling back an Operator upgrade by using the CLI

ifeval::["{context}" == "upgrade-cloudsvc-operator"]
:cloud-svc:
endif::[]

You can roll back the Operator version by using CLI commands.

.Procedure

. Delete the {olm} subscription by running the following command:
* For {ocp}, run the following command:
+
[source,terminal]
----
$ oc -n rhacs-operator delete subscription rhacs-operator
----
* For Kubernetes, run the following command:
+
[source,terminal]
----
$ kubectl -n rhacs-operator delete subscription rhacs-operator
----
. Delete the cluster service version (CSV) by running the following command:
* For {ocp}, run the following command:
+
[source,terminal]
----
$ oc -n rhacs-operator delete csv -l operators.coreos.com/rhacs-operator.rhacs-operator
----
* For Kubernetes, run the following command:
+
[source,terminal]
----
$ kubectl -n rhacs-operator delete csv -l operators.coreos.com/rhacs-operator.rhacs-operator
----
ifndef::cloud-svc[]
. Determine the previous version you want to roll back to by choosing one of the following options:
* If the current Central instance is running, query the {product-title-short} API to get the rollback version by running the following command:
+
[source,terminal]
----
$ curl -k -s -u <user>:<password> https://<central hostname>/v1/centralhealth/upgradestatus | jq -r .upgradeStatus.forceRollbackTo
----
* If the current Central instance is not running, perform the following steps:
+
[NOTE]
====
This procedure can only be used for {product-title-short} release 3.74 and earlier when the `rocksdb` database is installed.
====
.. Ensure the Central deployment is scaled down by running the following command:
** For {ocp}, run the following command:
+
[source,terminal]
----
$ oc scale -n <central namespace> –replicas=0 deploy/central
----
** For Kubernetes, run the following command:
+
[source,terminal]
----
$ kubectl scale -n <central namespace> –replicas=0 deploy/central
----
.. Save the following pod spec as a YAML file:
+

[source,yaml,subs="attributes+"]
----
apiVersion: v1
kind: Pod
metadata:
  name: get-previous-db-version
spec:
  containers:
  - name: get-previous-db-version
    image: registry.redhat.io/advanced-cluster-security/rhacs-main-rhel8:<rollback version>
    command:
    - sh
    args:
    - '-c'
    - "cat /var/lib/stackrox/.previous/migration_version.yaml | grep '^image:' | cut -f 2 -d : | tr -d ' '"
    volumeMounts:
    - name: stackrox-db
      mountPath: /var/lib/stackrox
  volumes:
  - name: stackrox-db
    persistentVolumeClaim:
      claimName: stackrox-db
----
.. Create a pod in your Central namespace by running the following command using the YAML file that you saved:
** For {ocp}, run the following command:
+
[source,terminal]
----
$ oc create -n <central namespace> -f pod.yaml
----
** For Kubernetes, run the following command:
+
[source,terminal]
----
$ kubectl create -n <central namespace> -f pod.yaml
----
.. After pod creation is complete, get the version by running the following command:
** For {ocp}, run the following command:
+
[source,terminal]
----
$ oc logs -n <central namespace> get-previous-db-version
----
** For Kubernetes, run the following command:
+
[source,terminal]
----
$ kubectl logs -n <central namespace> get-previous-db-version
----

. Edit the `central-config.yaml` `ConfigMap` to set the `maintenance.forceRollBackVersion:<version>` parameter by running the following command:
* For {ocp}, run the following command:
+
[source,terminal]
----
$ oc get configmap -n <central namespace> central-config -o yaml | sed -e "s/forceRollbackVersion: none/forceRollbackVersion: <version>/" | oc -n <central namespace> apply -f -
----
* For Kubernetes, run the following command:
+
[source,terminal]
----
$ kubectl get configmap -n <central namespace> central-config -o yaml | sed -e "s/forceRollbackVersion: none/forceRollbackVersion: <version>/" | kubectl -n <central namespace> apply -f -
----
. Set the image for the Central deployment using the version string shown in Step 3 as the image tag. For example, run the following command:
* For {ocp}, run the following command:
+
[source,terminal]
----
$ oc set image -n <central namespace> deploy/central central=registry.redhat.io/advanced-cluster-security/rhacs-main-rhel8:<version>
----
* For Kubernetes, run the following command:
+
[source,terminal]
----
$ kubectl set image -n <central namespace> deploy/central central=registry.redhat.io/advanced-cluster-security/rhacs-main-rhel8:<version>
----

.Verification

. Ensure that the Central pod starts and has a `ready` status. If the pod crashes, check the logs to see if the backup was restored. A successful log message appears similar to the following example:
+
----
Clone to Migrate ".previous", ""
----
endif::cloud-svc[]
ifndef::cloud-svc[]
. Reinstall the Operator on the rolled back channel. For example, `3.74.2` is installed on the `rhacs-3.74` channel.
endif::[]
ifdef::cloud-svc[]
. Install the latest version of the Operator on the rolled back channel.
endif::[]

ifeval::["{context}" == "upgrade-cloudsvc-operator"]
:!cloud-svc:
endif::[]