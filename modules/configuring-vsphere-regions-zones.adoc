// Module included in the following assemblies:
//
//* installing/Installing-vsphere-installer-provisioned-customizations.adoc [IPI]
//* installing/installing-vsphere-installer-provisioned-network-customizations.adoc [IPI]
//* installing/installing-vsphere.adoc [UPI]
//* installing/installing-vsphere-network-customizations.adoc [UPI]
//* installing/installing-restricted-networks-installer-provisioned-vsphere.adoc [IPI]
//* installing/installing-restricted-networks-vsphere.adoc [IPI]

:_mod-docs-content-type: PROCEDURE
[id="configuring-vsphere-regions-zones_{context}"]
= Configuring regions and zones for a VMware vCenter
You can modify the default installation configuration file to deploy an {product-title} cluster to multiple vSphere datacenters that run in a single VMware vCenter.

:FeatureName: VMware vSphere region and zone enablement
include::snippets/technology-preview.adoc[]

[IMPORTANT]
====
The example uses the `govc` command. The `govc` command is an open source command available from VMware. The `govc` command is not available from Red Hat. Red Hat Support does not maintain the `govc` command. Instructions for downloading and installing `govc` are found on the VMware documentation website.
====

.Prerequisites
* You have an existing `install-config.yaml` installation configuration file.
+
[IMPORTANT]
====
You must specify at least one failure domain for your {product-title} cluster, so that you can provision datacenter objects for your VMware vCenter server. Consider specifying multiple failure domains if you need to provision virtual machine nodes in different datacenters, clusters, datastores, and other components. To enable regions and zones, you must define multiple failure domains for your {product-title} cluster.
====
+
[NOTE]
====
You cannot change a failure domain after you installed an {product-title} cluster on the VMware vSphere platform. You can add additional failure domains after cluster installation.
====

.Procedure

. Enter the following `govc` command-line tool commands to create the `openshift-region` and `openshift-zone` vCenter tag categories:
+
[IMPORTANT]
====
If you specify different names for the `openshift-region` and `openshift-zone` vCenter tag categories, the installation of the {product-title} cluster fails.
====
+
[source,terminal]
----
$ govc tags.category.create -d "OpenShift region" openshift-region
----
+
[source,terminal]
----
$ govc tags.category.create -d "OpenShift zone" openshift-zone
----

. To create a region tag for each region vSphere datacenter where you want to deploy your cluster, enter the following command in your terminal:
+
[source,terminal]
----
$ govc tags.create -c <region_tag_category> <region_tag>
----

. To create a zone tag for each vSphere cluster where you want to deploy your cluster, enter the following command:
+
[source,terminal]
----
$ govc tags.create -c <zone_tag_category> <zone_tag>
----

. Attach region tags to each vCenter datacenter object by entering the following command:
+
[source,terminal]
----
$ govc tags.attach -c <region_tag_category> <region_tag_1> /<datacenter_1>
----

. Attach the zone tags to each vCenter datacenter object by entering the following command:
+
[source,terminal]
----
$ govc tags.attach -c <zone_tag_category> <zone_tag_1> /<datacenter_1>/host/vcs-mdcnc-workload-1
----

. Change to the directory that contains the installation program and initialize the cluster deployment according to your chosen installation requirements.

.Sample `install-config.yaml` file with multiple datacenters defined in a vSphere center

[source,yaml]
----
apiVersion: v1
baseDomain: example.com
featureSet: TechPreviewNoUpgrade <1>
compute:
  name: worker
  replicas: 3
  vsphere:
    zones: <2>
      - "<machine_pool_zone_1>"
      - "<machine_pool_zone_2>"
controlPlane:
  name: master
  replicas: 3
  vsphere:
    zones: <2>
      - "<machine_pool_zone_1>"
      - "<machine_pool_zone_2>"
metadata:
  name: cluster
platform:
  vsphere:
    vcenter: <vcenter_server> <3>
    username: <username> <3>
    password: <password> <3>
    datacenter: datacenter <3>
    defaultDatastore: datastore <3>
    folder: "/<datacenter_name>/vm/<folder_name>/<subfolder_name>" <3>
    cluster: cluster <3>
    resourcePool: "/<datacenter_name>/host/<cluster_name>/Resources/<resource_pool_name>" <3>
    diskType: thin
    failureDomains: <4>
    - name: <machine_pool_zone_1> <5>
      region: <region_tag_1> <6>
      zone: <zone_tag_1> <7>
      topology: <8>
        datacenter: <datacenter1> <9>
        computeCluster: "/<datacenter1>/host/<cluster1>" <10>
        resourcePool: "/<datacenter1>/host/<cluster1>/Resources/<resourcePool1>" <11>
        networks: <12>
        - <VM_Network1_name>
        datastore: "/<datacenter1>/datastore/<datastore1>" <13>
    - name: <machine_pool_zone_2>
      region: <region_tag_2>
      zone: <zone_tag_2>
      topology:
        datacenter: <datacenter2>
        computeCluster: "/<datacenter2>/host/<cluster2>"
        networks:
        - <VM_Network2_name>
        datastore: "/<datacenter2>/datastore/<datastore2>"
        resourcePool: "/<datacenter2>/host/<cluster2>/Resources/<resourcePool2>"
        folder: "/<datacenter2>/vm/<folder2>"
# ...
----
<1> You must define set the `TechPreviewNoUpgrade` as the value for this parameter, so that you can use the VMware vSphere region and zone enablement feature.
<2> An optional parameter for specifying a vCenter cluster. You define a zone by using a tag from the `openshift-zone` tag category. If you do not define this parameter, nodes will be distributed among all defined failure-domains.
<3> The default vCenter topology. The installation program uses this topology information to deploy the bootstrap node. Additionally, the topology defines the default datastore for vSphere persistent volumes.
<4> Establishes the relationships between a region and zone. You define a failure domain by using vCenter objects, such as a datastore object. A failure domain defines the vCenter location for {product-title} cluster nodes. If you do not define this parameter, the installation program uses the default vCenter topology.
<5> Defines the name of the failure domain. Each failure domain is referenced in the `zones` parameter to scope a machine pool to the failure domain.
<6> You define a region by using a tag from the `openshift-region` tag category. The tag must be attached to the vCenter datacenter.
<7> You define a zone by using a tag from the `openshift-zone tag` category. The tag must be attached to the vCenter datacenter.
<8> Specifies the vCenter resources associated with the failure domain.
<9> An optional parameter for defining the vSphere datacenter that is associated with a failure domain. If you do not define this parameter, the installation program uses the default vCenter topology.
<10> An optional parameter for stating the absolute file path for the compute cluster that is associated with the failure domain. If you do not define this parameter, the installation program uses the default vCenter topology.
<11> An optional parameter for the installer-provisioned infrastructure. The parameter sets the absolute path of an existing resource pool where the installation program creates the virtual machines, for example, `/<datacenter_name>/host/<cluster_name>/Resources/<resource_pool_name>/<optional_nested_resource_pool_name>`. If you do not specify a value, resources are installed in the root of the cluster `/example_datacenter/host/example_cluster/Resources`.
<12> An optional parameter that lists any network in the vCenter instance that contains the virtual IP addresses and DNS records that you configured. If you do not define this parameter, the installation program uses the default vCenter topology.
<13> An optional parameter for specifying a datastore to use for provisioning volumes. If you do not define this parameter, the installation program uses the default vCenter topology.
