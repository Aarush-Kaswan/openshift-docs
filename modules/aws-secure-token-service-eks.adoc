// Module included in the following assemblies:
//
// * integration/integrate-using-short-lived-tokens.adoc
:_mod-docs-content-type: PROCEDURE
[id="amazon-secure-token-service-eks_{context}"]
= Configuring Elastic Kubernetes Service (EKS)

[role="_abstract"]
When running {rh-rhacs-first} on EKS, you can configure short-lived tokens through the Amazon Secure Token Service.

.Procedure
. Run the following command to enable the IAM OpenID Connect (OIDC) provider for your EKS cluster:
+
[source,terminal]
----
$ eksctl utils associate-iam-oidc-provider --cluster <cluster_name> --approve
----
. link:https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_create_for-user.html[Create an IAM role] for your EKS cluster.
. Edit the permission policy of the role and grant the permissions required by the integration. For example:
+
[source,json]
----
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "VisualEditor0",
            "Effect": "Allow",
            "Action": [
                "ecr:BatchCheckLayerAvailability",
                "ecr:BatchGetImage",
                "ecr:DescribeImages",
                "ecr:DescribeRepositories",
                "ecr:GetAuthorizationToken",
                "ecr:GetDownloadUrlForLayer",
                "ecr:ListImages"
            ],
            "Resource": "arn:aws:iam::<ecr_registry>:role/<role_name>"
        }
    ]
}
----
. Update the trust relationship for the role that you want to assume:
+
[source,json]
----
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "AWS": [
          "arn:aws:iam::<ecr-registry>:role/<role_name>" <1>
        ]
      },
      "Action": "sts:AssumeRole"
    }
  ]
}
----
<1> The `<role_name>` should match with the new role that you have created in earlier steps.
. Enter the following command to associate the newly created role with a service account:
+
[source,terminal]
----
$ oc -n stackrox annotate sa central eks.amazonaws.com/role-arn=arn:aws:iam::67890:role/<role_name> <1>
----
<1> If you use Kubernetes, enter `kubectl` instead of `oc`.

. Enter the following command to restart the Central pod and apply the changes:
+
[source,terminal]
----
$ oc -n stackrox delete pod -l "app in (central,sensor)" <1>
----
<1> If you use Kubernetes, enter `kubectl` instead of `oc`.
